#!/bin/bash
LOGFILE="$HOME/.brainrest.log"
GAPFILE="$HOME/.brainrest_gap"
DEFAULT_GAP=40
BREAK_DURATION=120
VERSION="1.0.0"

detect_os() {
    case "$(uname -s)" in
        Linux*) OS="Linux";;
        Darwin*) OS="Mac";;
        *) OS="Unknown";;
    esac
}

get_timestamp() {
    date +%s
}

check_dialog() {
    if ! command -v dialog &> /dev/null; then
        echo "Error: 'dialog' command not found."
        echo "Please install it:"
        echo "  Ubuntu/Debian: sudo apt install dialog"
        echo "  macOS: brew install dialog"
        echo "  Fedora: sudo dnf install dialog"
        exit 1
    fi
}

lock_terminal() {
    local lock_time=$BREAK_DURATION
    local original_time=$lock_time
    local old_stty=$(stty -g)
    stty -echo -icanon time 0 min 0 2>/dev/null
    
    while [ $lock_time -gt 0 ]; do
        local progress=$(( (original_time - lock_time) * 100 / original_time ))
        
        dialog --title "BRAINREST BREAK TIME" \
               --colors \
               --no-shadow \
               --infobox "\n\
   \Z2Time to rest your eyes and stretch!\Zn\n\n\
   ⏱  Time remaining: \Z1\Zb$((lock_time / 60)):$(printf "%02d" $((lock_time % 60)))\Zn\n\n\
   Progress: [$progress%]\n\n\
   \Z7Terminal is locked - please wait...\Zn" 11 50
        
        while read -t 0; do read -n 1 2>/dev/null; done
        sleep 1
        lock_time=$((lock_time - 1))
    done
    
    stty "$old_stty"
    
    dialog --title "Break Complete" \
           --colors \
           --msgbox "\n\Z2✓ Break Completed!\Zn\n\nYour terminal is now unlocked.\n\nFeel refreshed? " 10 40
    
    clear
    get_timestamp > "$LOGFILE"
}

show_help() {
    echo "brainrest - micro-break reminder tool"
    echo ""
    echo "Usage: brainrest [options]"
    echo ""
    echo "Options:"
    echo "  -s, --set MIN     Set break interval"
    echo "  -r, --reset       Reset break timer to default"
    echo "  -V, --visual      Launch visual dialog mode"
    echo "  -v, --version     Show version"
    echo "  -h, --help        Show this help"
}

get_time_remaining() {
    if [ -f "$LOGFILE" ]; then
        local last_break=$(cat "$LOGFILE")
        local now=$(get_timestamp)
        local diff_min=$(( (now - last_break) / 60 ))
        local remain=$(( CURRENT_GAP - diff_min ))
        
        if [ "$remain" -lt 0 ]; then
            echo "0"
        else
            echo "$remain"
        fi
    else
        echo "$CURRENT_GAP"
    fi
}

visual_mode() {
    check_dialog
    
    # Load current interval
    if [ -f "$GAPFILE" ]; then
        CURRENT_GAP=$(cat "$GAPFILE")
    else
        CURRENT_GAP=$DEFAULT_GAP
    fi
    
    while true; do
        local time_remaining=$(get_time_remaining)
        
        # Build status message
        local status_msg="Current Interval: $CURRENT_GAP minutes\nNext break in: "
        if [ "$time_remaining" -le 5 ] && [ "$time_remaining" -gt 0 ]; then
            status_msg+="\Z1\Zb$time_remaining minutes\Zn "
        else
            status_msg+="\Z2$time_remaining minutes\Zn"
        fi
        
        exec 3>&1
        selection=$(dialog \
            --title "BrainRest Visual Mode" \
            --colors \
            --ok-label "Select" \
            --cancel-label "Exit" \
            --extra-button \
            --extra-label "Help" \
            --menu "$status_msg\n\nChoose an option:" 16 60 4 \
            1 "Start BrainRest Monitor" \
            2 "Set Custom Interval" \
            3 "Reset to Default (40 min)" \
            4 "Exit" \
            2>&1 1>&3)
        exit_status=$?
        exec 3>&-
        
        case $exit_status in
            0)  # OK button
                case $selection in
                    1)  # Start Monitor
                        clear
                        echo "BrainRest Monitor Started"
                        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
                        echo "Interval: $CURRENT_GAP minutes"
                        echo "Press CTRL+C to return to menu"
                        echo ""
                        
                        trap 'echo ""; echo "Returning to menu..."; sleep 1; visual_mode; exit 0' INT
                        
                        while true; do
                            if [ -f "$LOGFILE" ]; then
                                last_break=$(cat "$LOGFILE")
                            else
                                last_break=0
                            fi
                            
                            now=$(get_timestamp)
                            diff_min=$(( (now - last_break) / 60 ))
                            
                            if [ "$diff_min" -ge "$CURRENT_GAP" ]; then
                                echo ""
                                echo "Time is up! Starting break..."
                                sleep 1
                                lock_terminal
                            else
                                remain=$(( CURRENT_GAP - diff_min ))
                                echo -ne "Next break in: $remain minutes...    \r"
                            fi
                            
                            sleep 30
                        done
                        ;;
                    2)  # Set Custom Interval
                        exec 3>&1
                        new_gap=$(dialog \
                            --title "Set Custom Interval" \
                            --inputbox "Enter new interval in minutes:\n(Current: $CURRENT_GAP minutes)" 10 50 \
                            2>&1 1>&3)
                        exit_status=$?
                        exec 3>&-
                        
                        if [ $exit_status -eq 0 ]; then
                            if [[ "$new_gap" =~ ^[0-9]+$ ]] && [ "$new_gap" -gt 0 ]; then
                                echo "$new_gap" > "$GAPFILE"
                                get_timestamp > "$LOGFILE"
                                CURRENT_GAP=$new_gap
                                dialog --title "Success" \
                                       --colors \
                                       --msgbox "\n\Z2✓ Interval set to $new_gap minutes.\Zn" 7 40
                            else
                                dialog --title "Error" \
                                       --colors \
                                       --msgbox "\n\Z1✗ Invalid number. Please enter a positive integer.\Zn" 8 45
                            fi
                        fi
                        ;;
                    3)  # Reset to Default
                        dialog --title "Confirm Reset" \
                               --yesno "\nReset to default 40 minutes?\n\nThis will clear break history." 9 45
                        
                        if [ $? -eq 0 ]; then
                            rm -f "$GAPFILE"
                            rm -f "$LOGFILE"
                            CURRENT_GAP=$DEFAULT_GAP
                            dialog --title "Reset Complete" \
                                   --colors \
                                   --msgbox "\n\Z2✓ Reset to default (40 minutes).\Zn" 7 40
                        fi
                        ;;
                    4)  # Exit
                        clear
                        echo "Goodbye!"
                        exit 0
                        ;;
                esac
                ;;
            1)  # Cancel button
                clear
                echo "Goodbye!"
                exit 0
                ;;
            3)  # Extra button (Help)
                dialog --title "BrainRest Help" \
                       --msgbox "\
BrainRest - Micro-break Reminder Tool

KEYBOARD SHORTCUTS:
• Arrow keys (↑/↓) - Navigate menu
• ENTER - Select option
• ESC - Go back/Exit
• Tab - Switch between buttons

FEATURES:
• Start Monitor: Runs in background, auto-locks terminal when time is up
• Set Interval: Customize break frequency (in minutes)
• Reset: Return to default 40-minute interval

TIPS:
• Take breaks seriously - your health matters!
• Use 20-20-20 rule: Every 20 min, look 20 feet away for 20 seconds
• Stand up and stretch during breaks

Version: $VERSION" 24 70
                ;;
        esac
    done
}

# LOAD INTERVAL
detect_os
if [ -f "$GAPFILE" ]; then
    CURRENT_GAP=$(cat "$GAPFILE")
else
    CURRENT_GAP=$DEFAULT_GAP
fi

# COMMAND-LINE OPTIONS
if [ $# -gt 0 ]; then
    if [ "$1" == "--visual" ] || [ "$1" == "-V" ]; then
        visual_mode
    fi
    
    case "$1" in
        -s|--set)
            shift
            if ! [[ "$1" =~ ^[0-9]+$ ]]; then
                echo "Error: time must be a number"
                exit 1
            fi
            echo "$1" > "$GAPFILE"
            get_timestamp > "$LOGFILE"
            echo "✓ Break timer set to $1 minutes."
            exit 0
            ;;
        -r|--reset)
            rm -f "$GAPFILE"
            rm -f "$LOGFILE"
            echo "✓ Reset to default (40 minutes)."
            exit 0
            ;;
        -v|--version)
            echo "brainrest version $VERSION (running on $OS)"
            exit 0
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use -h or --help for usage information"
            exit 1
            ;;
    esac
fi

# MAIN AUTO BREAK LOOP
echo "BrainRest Monitor Started"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Interval: $CURRENT_GAP minutes"
echo "Press CTRL+C to exit"
echo ""

while true; do
    if [ -f "$LOGFILE" ]; then
        last_break=$(cat "$LOGFILE")
    else
        last_break=0
    fi
    
    now=$(get_timestamp)
    diff_min=$(( (now - last_break) / 60 ))
    
    if [ "$diff_min" -ge "$CURRENT_GAP" ]; then
        echo ""
        echo "Time is up! Starting break..."
        sleep 1
        lock_terminal
    else
        remain=$(( CURRENT_GAP - diff_min ))
        echo -ne "Next break in: $remain minutes...    \r"
    fi
    
    sleep 30
done
